<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>jsonata-functions.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/martinholden-skillsoft/jsonata-extended.git" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Modules</h3><ul><li><a href="module-jsonata-functions.html">jsonata-functions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-jsonata-functions.html#~htmltotext">htmltotext</a></li><li data-type='method' style='display: none;'><a href="module-jsonata-functions.html#~languageInfo">languageInfo</a></li><li data-type='method' style='display: none;'><a href="module-jsonata-functions.html#~registerWithJSONATA">registerWithJSONATA</a></li><li data-type='method' style='display: none;'><a href="module-jsonata-functions.html#~shortenUuid">shortenUuid</a></li><li data-type='method' style='display: none;'><a href="module-jsonata-functions.html#~truncate">truncate</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#jsonataExtended">jsonataExtended</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">jsonata-functions.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Extension functions for JSONata
 * @module jsonata-functions
 * @exports registerWithJSONATA
 */
const htmlToText = require('html-to-text');
const uuidvalidate = require('uuid-validate');
const UuidEncoder = require('uuid-encoder');
const _ = require('lodash');
const LanguageTag = require('rfc5646');
const countriesList = require('countries-list');

/**
 * Convert HTML to plain text
 * @access private
 * @param {String} value The HTML string to convert
 * @param {Object} [options={}] The options object. For more information see the {@link https://www.npmjs.com/package/html-to-text|html-to-text NPM}
 * @param {String[]|String|Boolean} [options.tables=[]] allows to select certain tables by the 'class' or 'id' attribute from the HTML document. This is necessary because the majority of HTML E-Mails uses a table based layout. Prefix your table selectors with an '.' for the 'class' and with a '#' for the 'id' attribute. All other tables are ignored. You can assign 'true' to this attribute to select all tables.
 * @param {Number} [options.wordwrap=80] defines after how many chars a line break should follow in 'p' elements. Set to 'null' or 'false' to disable word-wrapping.
 * @param {String} [options.linkHrefBaseUrl=null] allows you to specify the server host for href attributes, where the links start at the root ('/'). For example, 'linkHrefBaseUrl = 'http://asdf.com'' and '&lt;a href='/dir/subdir'>...&lt;/a>' the link in the text will be 'http://asdf.com/dir/subdir'. Keep in mind that 'linkHrefBaseUrl' shouldn't end with a '/'.
 * @param {Boolean} [options.hideLinkHrefIfSameAsText=false] allows you to specify the server host for href attributes, where the links start at the root ('/'). For example, 'linkHrefBaseUrl = 'http://asdf.com'' and '&lt;a href='/dir/subdir'>...&lt;/a>' the link in the text will be 'http://asdf.com/dir/subdir'. Keep in mind that 'linkHrefBaseUrl' shouldn't end with a '/'.
 * @param {Boolean} [options.noLinkBrackets=false] dont print brackets around the link if 'true'
 * @param {Boolean} [options.ignoreHref=false] ignore all document links if 'true'
 * @param {Boolean} [options.ignoreImage=false] ignore all document images if 'true'.
 * @param {Boolean} [options.preserveNewlines=false] by default, any newlines \n in a block of text will be removed. If true, these newlines will not be removed.
 * @param {Boolean} [options.uppercaseHeadings=true] by default, headings (h1, h2, etc) are uppercased. Set to 'false' to leave headings as they are.
 * @param {Boolean} [options.singleNewLineParagraphs=false] by default, paragraphs are converted with two newlines ('\n\n'). Set to 'true' to convert to a single newline.
 * @param {String|String[]} [options.baseElement='body'] defines the tags whose text content will be captured from the html.  All content will be captured below the baseElement tags and added to the resulting text output.  This option allows the user to specify an array of elements as base elements using a single tag with css class and id parameters e.g. ['p.class1.class2#id1#id2', 'p.class1.class2#id1#id2'].
 * @param {Boolean} [options.returnDomByDefault=true] onvert the entire document if we don't find the tag we're looking for if 'true'
 * @param {String} [options.unorderedListItemPrefix=' * '] defines the string that is used as item prefix for unordered lists '&amp;lt;ol&amp;gt;'
 * @param {Object} [options.longWordSplit={}] describes how to wrap long words
 * @param {String[]} [options.longWordSplit.wrapCharacters=[]] is an array containing the characters that may be wrapped on, these are used in order
 * @param {Boolean} [options.longWordSplit.forceWrapOnLimit=false] defines whether to break long words on the limit if 'true'
 * @param {Object} [options.decodeOptions={}] defines the text decoding options given to 'he.decode'. For more informations see the {@link https://www.npmjs.com/package/he|HE NPM}.
 * @param {Boolean} [options.decodeOptions.isAttributeValue=false] false means that decode() will decode the string as if it were used in a text context in an HTML document. HTML has different rules for parsing character references in attribute values â€” set this option to true to treat the input string as if it were used as an attribute value.
 * @param {Boolean} [options.decodeOptions.strict=false] false means that decode() will decode any HTML text content you feed it, even if it contains any entities that cause parse errors. To throw an error when such invalid HTML is encountered, set the strict option to true. This option makes it possible to use he as part of HTML parsers and HTML validators.
 * @param {Object} [options.format={}}] pass an object to enable custom formatting for specific elements. By using the format option, you can specify formatting for these elements: text, image, lineBreak, paragraph, anchor, heading, table, orderedList, unorderedList, listItem, horizontalLine. Each key must be a function which eventually receive elem (the current elem), fn (the next formatting function) and options (the options passed to html-to-text).
 * @example &lt;caption>Example usage. The &amp;lt;p&amp;gt; tags and the HTML entities are converted&lt;/caption>
 * // returns
 * // 'Leadership has a dark side; a "leadership shadow" that often creates an unknown; lurking fear.'
 * htmltotext('&lt;p>Leadership has a dark side; a &amp;#34;leadership shadow&amp;#34; that often creates an unknown; lurking fear.&lt;/p>');
 * @example &lt;caption>Example usage within a JSONata transform. The &amp;lt;p&amp;gt; tags and the HTML entities are converted&lt;/caption>
 * // returns
 * // result = 'Leadership has a dark side; a "leadership shadow" that often creates an unknown; lurking fear.'
 * const jsonata = require('./lib/jsonata/jsonata-extended');
 * const expr = jsonata('$htmltotext("&lt;p>Leadership has a dark side; a &amp;#34;leadership shadow&amp;#34; that often creates an unknown; lurking fear.&lt;/p>")');
 * const result = expr.evaluate();
 * @see {@link https://www.npmjs.com/package/html-to-text|html-to-text NPM}
 * @see {@link https://www.npmjs.com/package/he|HE NPM}
 * @returns {String|Void} Returns a string of the plain text, or undefined for undefined input
 */
const htmltotext = (value, options) => {
  if (typeof value === 'undefined') {
    return undefined;
  }

  // Default options for https://www.npmjs.com/package/html-to-text
  const defaultOptions = {
    noLinkBrackets: false,
    wordwrap: null
  };

  const localOptions = { ...defaultOptions, ...options };

  return htmlToText.fromString(value.trim(), localOptions);
};

/**
 * Shorten the supplied UUID
 * @access private
 * @param {String} value - Properly formatted UUID
 * @example &lt;caption>Example usage&lt;/caption>
 * // returns
 * // '1m5otdkthiyq143crwujacdqg'
 * shortenUuid('1b49aa30-e719-11e6-9835-f723b46a2688');
 * @example &lt;caption>Example usage within a JSONata transform&lt;/caption>
 * // returns
 * // result = '1m5otdkthiyq143crwujacdqg'
 * const jsonata = require('./lib/jsonata/jsonata-extended');
 * const expr = jsonata('$shortenUuid("1b49aa30-e719-11e6-9835-f723b46a2688")');
 * const result = expr.evaluate();
 * @throws Will throw an error if the value is not a valid uuid
 * @see {@link https://www.npmjs.com/package/uuid-encoder|uuid-encoder NPM}
 * @returns {String|Void} Returns a string containing the encoded version of the uuid, or undefined for undefined input
 */
const shortenUuid = value => {
  if (typeof value === 'undefined') {
    return undefined;
  }

  if (!uuidvalidate(value)) {
    throw new Error('Invalid UUID');
  }

  return new UuidEncoder('base36').encode(value);
};

/**
 * Truncate the string
 * @access private
 * @param {String} [value=''] The string to truncate.
 * @param {Object} [options={}] The options object. For more information see the {@link https://www.npmjs.com/package/lodash|lodash NPM} truncate function
 * @param {number} [options.length=30] The maximum string length.
 * @param {String} [options.omission='...'] The string to indicate text is omitted.
 * @param {RegExp|String} [options.separator] The separator pattern to truncate to.
 * @example &lt;caption>Example usage with default options&lt;/caption>
 * // returns
 * // '123456789012345678901234567...'
 * truncate('1234567890123456789012345678901234567890');
 * @example &lt;caption>Example usage with option for length of 13&lt;/caption>
 * // returns
 * // '1234567890...'
 * truncate('1234567890123456789012345678901234567890', { length: 13 });
 * @example &lt;caption>Example usage within a JSONata transform for length of 13&lt;/caption>
 * // returns
 * // result = '1234567890...'
 * const jsonata = require('./lib/jsonata/jsonata-extended');
 * const expr = jsonata('$truncate("1234567890123456789012345678901234567890", {"length": 13, "omission": "..."})');
 * const result = expr.evaluate();
 * @see {@link https://www.npmjs.com/package/lodash|lodash NPM}
 * @returns {String|Void} Returns the truncated string, or undefined for undefined input
 */
const truncate = (value, options) => {
  if (typeof value === 'undefined') {
    return undefined;
  }

  const defaultOptions = {};

  const localOptions = { ...defaultOptions, ...options };

  return _.truncate(value, localOptions);
};

/**
 * Get detailed information based on an RFC5646 tag for region and language
 * @access private
 * @param {String} value The RFC5646 locales to retrieve detailed information on
 * @example &lt;caption>Example usage with single tag with language and locale&lt;/caption>
 * // returns
 * // {
 * //     "rfc5646": "en-US",
 * //     "region": {
 * //       "name": "United States",
 * //       "native": "United States",
 * //       "phone": "1",
 * //       "continent": "NA",
 * //       "capital": "Washington D.C.",
 * //       "currency": "USD,USN,USS",
 * //       "languages": [
 * //         "en"
 * //       ],
 * //       "emoji": "ðŸ‡ºðŸ‡¸",
 * //       "emojiU": "U+1F1FA U+1F1F8"
 * //     },
 * //     "language": {
 * //       "name": "English",
 * //       "native": "English"
 * //     }
 * //   }
 * // }
 * languageInfo('en-US');
 * @example &lt;caption>Example usage with single tag with language only&lt;/caption>
 * // returns
 * // {
 * //     "rfc5646": "es",
 * //     "region": null,
 * //     "language": {
 * //       "name": "Spanish",
 * //       "native": "EspaÃ±ol"
 * //     }
 * //   }
 * // }
 * languageInfo('es');
 * @example &lt;caption>Example usage within a JSONata transform to get the region native language name for a locale&lt;/caption>
 * // returns
 * // result = "ä¸­æ–‡"
 * const jsonata = require('./lib/jsonata/jsonata-extended');
 * const expr = jsonata('$languageInfo("zh-CN").language.native');
 * const result = expr.evaluate();
 * @example &lt;caption>Example usage within a JSONata transform to get the information for three locales&lt;/caption>
 * // returns
 * // result = [
 * //      {
 * //         "region": {
 * //          "name": "United States",
 * //          "native": "United States",
 * //          "phone": "1",
 * //          "continent": "NA",
 * //          "capital": "Washington D.C.",
 * //          "currency": "USD,USN,USS",
 * //          "languages": [
 * //            "en"
 * //          ],
 * //          "emoji": "ðŸ‡ºðŸ‡¸",
 * //          "emojiU": "U+1F1FA U+1F1F8"
 * //        },
 * //        "language": {
 * //          "name": "English",
 * //          "native": "English"
 * //        },
 * //        "rfc5646": "en-US"
 * //      },
 * //      {
 * //        "region": {
 * //          "name": "France",
 * //          "native": "France",
 * //          "phone": "33",
 * //          "continent": "EU",
 * //          "capital": "Paris",
 * //          "currency": "EUR",
 * //          "languages": [
 * //            "fr"
 * //          ],
 * //          "emoji": "ðŸ‡«ðŸ‡·",
 * //          "emojiU": "U+1F1EB U+1F1F7"
 * //        },
 * //        "language": {
 * //          "name": "French",
 * //          "native": "FranÃ§ais"
 * //        },
 * //        "rfc5646": "fr-FR"
 * //      },
 * //      {
 * //        "region": {
 * //          "name": "China",
 * //          "native": "ä¸­å›½",
 * //          "phone": "86",
 * //          "continent": "AS",
 * //          "capital": "Beijing",
 * //          "currency": "CNY",
 * //          "languages": [
 * //            "zh"
 * //          ],
 * //          "emoji": "ðŸ‡¨ðŸ‡³",
 * //          "emojiU": "U+1F1E8 U+1F1F3"
 * //        },
 * //        "language": {
 * //          "name": "Chinese",
 * //          "native": "ä¸­æ–‡"
 * //        },
 * //        "rfc5646": "zh-CN"
 * //      }
 * //    ]
 * const jsonata = require('./lib/jsonata/jsonata-extended');
 * const expr = jsonata('$.( $allLocales:= ["en-US", "fr-FR", "zh-CN"]; $map($allLocales, function($v, $i, $a) { $languageInfo($v) }) )');
 * const result = expr.evaluate();
 * @example &lt;caption>Example usage within a JSONata transform to get a new object with the RFC5646 tag, and a string 'region (language)' representing the native locale for three locales&lt;/caption>
 * // returns
 * // result = [
 * //        {
 * //        "rfc5646": "en-US",
 * //        "locale": "United States (English)"
 * //        },
 * //        {
 * //        "rfc5646": "fr-FR",
 * //        "locale": "France (FranÃ§ais)"
 * //        },
 * //        {
 * //        "rfc5646": "zh-CN",
 * //        "locale": "ä¸­å›½ (ä¸­æ–‡)"
 * //        }
 * //      ]
 * const jsonata = require('./lib/jsonata/jsonata-extended');
 * const expr = jsonata('$.( $allLocales:= ["en-US", "fr-FR", "zh-CN"]; $map($allLocales, function($v, $i, $a) { ( $lang := $languageInfo($v); { "rfc5646": $lang.rfc5646, "locale" : $lang.region.native &amp; " (" &amp; $lang.language.native &amp;")" })}) )');
 * const result = expr.evaluate();
 * @throws Will throw an error if the value is not a valid RFC5646 language tag
 * @returns {Object[]|Void} object contain details on the region and language, region is null if language only passed. Returns undefined for undefined input
 */
const languageInfo = value => {
  if (typeof value === 'undefined') {
    return undefined;
  }

  const langTag = new LanguageTag(value);

  const response = { rfc5646: null, region: null, language: null };

  // The language tag is valid
  if (langTag.invalid) {
    throw new Error(`Invalid RFC5646 Tag. Value: ${value}`);
  }

  response.rfc5646 = value;
  response.region = langTag.region ? countriesList.countries[langTag.region] : null;
  response.language = langTag.language ? countriesList.languagesAll[langTag.language] : null;
  return response;
};

/**
 * Register the functions in this library to the JSONata expression
 * @access public
 * @param {Object} expression - The JSONata Expression Object {@link https://www.npmjs.com/package/jsonata|JSONata NPM}
 * @throws {TypeError} expression must be a JSONata expression object
 *
 * @example &lt;caption>Example usage to add the functions in this library to a JSONata expression object, and utilise them&lt;/caption>
 * const jsonata = require('jsonata');
 * const jsonataFunctions = require('./lib/jsonata/jsonata-functions');
 *
 * const expression = jsonata('$htmltotext("&lt;p>Leadership has a dark side; a &amp;#34;leadership shadow&amp;#34; that often creates an unknown; lurking fear.&lt;/p>")');
 * jsonataFunctions.registerWithJSONATA(expression);
 * const result = expression.evaluate();
 * @see {@link https://www.npmjs.com/package/jsonata|JSONata NPM}
 */
const registerWithJSONATA = expression => {
  if (typeof expression === 'undefined' || typeof expression.registerFunction === 'undefined') {
    throw new TypeError('Invalid JSONata Expression');
  }
  expression.registerFunction(
    'htmltotext',
    (value, options) => htmltotext(value, options),
    '&lt;s?o?:s>'
  );

  expression.registerFunction('shortenUuid', value => shortenUuid(value), '&lt;s?:s>');

  expression.registerFunction('truncate', (value, options) => truncate(value, options), '&lt;s?o?:s>');

  expression.registerFunction('languageInfo', value => languageInfo(value), '&lt;s?:o>');
};

module.exports = {
  registerWithJSONATA
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
